@attribute [Route(Routes.Dashboard)]
@using Eggbox.Services
@using Eggbox.Models

@inject Mixer Mixer
@inject MixerModel Model
@inject NavigationManager Nav

<PageTitle>Dashboard</PageTitle>

<div class="p-4 space-y-4">
    <style>
        .fader-vertical {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            height: 180px;
            width: 28px;
        }

        .fader-card {
            transition: background 0.2s ease, transform 0.1s ease;
        }

        .fader-card:hover {
            background: rgba(255, 255, 255, 0.85);
            transform: scale(1.02);
        }
    </style>

    <div class="flex justify-between items-center">
        <div class="flex items-center gap-2">
            <h1 class="text-xl font-semibold">Mixer Dashboard</h1>

            <select @bind="_selectedOutput" class="select select-sm select-bordered ml-3">
                <option value="0">Main LR</option>

                @foreach (var b in Model.Busses)
                {
                    <option value="@b.Index">Bus @b.Index (@b.Name)</option>
                }
            </select>
        </div>

        <div class="flex items-center gap-2">
            <button class="btn btn-sm" @onclick="Reload">↻ Reload</button>
            <NavLink href="@Routes.OscMonitor" class="btn btn-primary btn-sm">OSC Monitor</NavLink>
        </div>
    </div>

    @if (_loading)
    {
        <div class="text-neutral-500 text-sm mt-3">Loading...</div>
    }
    else if (_channels.Any())
    {
        <div class="grid gap-3 grid-cols-4 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12 mt-3">
            @foreach (var ch in _channels)
            {
                <div class="rounded-lg border p-3 text-center bg-white/60 backdrop-blur fader-card">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-sm">@ch.Name</span>

                        <input type="checkbox"
                               checked="@ch.Muted"
                               @onchange="(e) => ToggleMute(ch, (bool)e.Value!)"
                               title="Mute channel" />
                    </div>

                    <input type="range"
                           min="0" max="1" step="0.01"
                           value="@ch.Fader"
                           class="fader-vertical"
                           @oninput="(e) => OnFaderChanged(ch, Convert.ToSingle(e.Value))" />

                    <div class="text-xs mt-1 text-center">@((int)(ch.Fader * 100))%</div>

                    <div class="w-full h-1.5 mt-2 rounded-full"
                         style="background:@ch.Color.HexCode"></div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-neutral-500 text-sm mt-3">No channels loaded</div>
    }
</div>

@code {
    private bool _loading = true;
    private int _selectedOutput = 0; // 0 = Main LR
    private List<ChannelVm> _channels = new();

    protected override void OnInitialized()
    {
        // Rebuild UI when mixer state changes
        Model.StateChanged += _ =>
        {
            BuildVM();
            InvokeAsync(StateHasChanged);
        };

        BuildVM();
        _loading = false;
    }

    private void BuildVM()
    {
        _channels = Model.Channels.Select(ch =>
        {
            float fader = _selectedOutput == 0
                ? ch.Fader            // main mix fader
                : ch.Sends.TryGetValue(_selectedOutput, out var s) ? s.Level : 0f;

            bool mute = _selectedOutput == 0
                ? ch.Mute
                : ch.Sends.TryGetValue(_selectedOutput, out var s2) && s2.Mute;

            return new ChannelVm
            {
                Index = ch.Index,
                Name = ch.Name ?? $"Ch {ch.Index:D2}",
                Fader = fader,
                Muted = mute,
                Color = ch.Color
            };
        }).ToList();
    }

    private async Task Reload()
    {
        _loading = true;
        StateHasChanged();

        // Request fresh values from mixer
        for (int i = 1; i <= Model.Info.ChannelCount; i++)
        {
            // The parser will update Model.State
            await Mixer.Channel(i).RequestRefreshAsync();
        }

        _loading = false;
        BuildVM();
        StateHasChanged();
    }

    private async Task OnFaderChanged(ChannelVm vm, float value)
    {
        vm.Fader = value;

        if (_selectedOutput == 0)
            await Mixer.Main().Channel(vm.Index).SetFader(value);
        else
            await Mixer.Bus(_selectedOutput).Channel(vm.Index).SetFader(value);
    }

    private async Task ToggleMute(ChannelVm vm, bool muted)
    {
        vm.Muted = muted;

        if (_selectedOutput == 0)
            await Mixer.Main().Channel(vm.Index).SetMute(muted);
        else
            await Mixer.Bus(_selectedOutput).Channel(vm.Index).SetMute(muted);
    }

    private sealed class ChannelVm
    {
        public int Index { get; set; }
        public string Name { get; set; } = "";
        public float Fader { get; set; }
        public bool Muted { get; set; }
        public MixerColor Color { get; set; } = MixerColor.Red;
    }
}
