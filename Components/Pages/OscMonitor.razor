@attribute [Route(Routes.OscMonitor)]
@using Eggbox.Services
@using Eggbox.Models
@inject MixerIO IO
@inject MixerTrafficLogService Traffic

<h3 class="text-xl font-semibold mb-4">OSC Monitor</h3>

<div class="mb-3 flex gap-2">
    <input @bind="command" placeholder="/ch/01/mix/fader 0.75"
           class="input input-bordered w-full" />

    <button @onclick="SendCommand" class="btn btn-primary">Send</button>
</div>

<div style="max-height:400px; overflow-y:auto; font-family:monospace;"
     class="border p-2 rounded text-sm">
    @foreach (var entry in Traffic.Log.Reverse().Take(400))
    {
        <div>
            @entry.Timestamp.ToString("HH:mm:ss.fff")
            @(" ")
            @(entry.IsTx ? "TX" : "RX")
            @(" ")
            @entry.Address
            @("  ")
            @string.Join(" ", entry.Arguments.Select(a => a?.ToString()))
            @("  ")
            @($"({(entry.Handled ? "handled" : "unhandled")})")
        </div>
    }
</div>

@code {
    private string command = "";

    private async Task SendCommand()
    {
        if (string.IsNullOrWhiteSpace(command)) return;

        var parts = command.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        var address = parts[0];
        var argStrings = parts.Skip(1).ToArray();

        // Parse string arguments to real OSC types
        object[] oscArgs = argStrings.Select(ParseArgument).ToArray();

        var msg = new OscCore.OscMessage(address, oscArgs);

        await IO.SendAsync(msg);

        command = "";
    }

    private object ParseArgument(string raw)
    {
        // int?
        if (int.TryParse(raw, out var intVal))
            return intVal;

        // float?
        if (float.TryParse(raw, System.Globalization.NumberStyles.Any,
                           System.Globalization.CultureInfo.InvariantCulture, out var floatVal))
            return floatVal;

        // else string
        return raw;
    }
}
